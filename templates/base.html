<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>{% block title %}Reativa – Encontre seu espaço{% endblock %}</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32.png">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <meta name="theme-color" content="#1f2937">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['-apple-system', 'BlinkMacSystemFont', 'SF Pro Display', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                    },
                    colors: {
                        gray: {
                            50: '#FBFBFD',
                            100: '#F7F7FA',
                            200: '#EDEDF2',
                            300: '#D2D2DC',
                            400: '#8E8E93',
                            500: '#636366',
                            600: '#48484A',
                            700: '#363638',
                            800: '#242426',
                            900: '#1C1C1E',
                        },
                        blue: {
                            500: '#007AFF',
                            600: '#0051D5',
                        }
                    },
                    spacing: {
                        '18': '4.5rem',
                        '88': '22rem',
                    },
                    fontSize: {
                        'xxs': '0.625rem',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                    },
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(10px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Smooth transitions for all interactive elements */
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Smooth scroll behavior for pagination */
        html {
            scroll-behavior: smooth;
        }
        
        /* Adjust scroll position for sticky header */
        #property-list-top {
            scroll-margin-top: 80px;
        }
        
        /* Custom focus styles */
        .focus-ring:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }
        
        /* Subtle hover for cards */
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: scale(1.02);
            box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.15);
        }
        
        /* Search input refinements */
        .search-input {
            transition: all 0.2s ease;
        }
        
        .search-input:focus {
            background-color: white;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1), 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        /* Minimal scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #D2D2DC;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #8E8E93;
        }
        
        /* Image loading animation */
        .image-loading {
            background: linear-gradient(90deg, #F7F7FA 0%, #EDEDF2 50%, #F7F7FA 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Premium button styles */
        .btn-primary {
            background: linear-gradient(180deg, #007AFF 0%, #0051D5 100%);
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        /* Filter Pills Styling */
        .filter-pill-active {
            transform: scale(1);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(8px);
            animation: filterPillEnter 0.3s ease-out;
        }
        
        .filter-pill-active:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .filter-pill-suggestion {
            transform: scale(1);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            animation: filterPillEnter 0.3s ease-out;
            animation-fill-mode: both;
        }
        
        .filter-pill-suggestion:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .filter-pill-suggestion:active {
            transform: scale(0.98);
        }
        
        @keyframes filterPillEnter {
            0% {
                opacity: 0;
                transform: scale(0.9);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.02);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Mobile-optimized filter scroll */
        #filter-suggestions {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        
        #filter-suggestions::-webkit-scrollbar {
            display: none;
        }
        
        /* Stagger animation for suggestions */
        .filter-pill-suggestion:nth-child(1) { animation-delay: 0ms; }
        .filter-pill-suggestion:nth-child(2) { animation-delay: 50ms; }
        .filter-pill-suggestion:nth-child(3) { animation-delay: 100ms; }
        .filter-pill-suggestion:nth-child(4) { animation-delay: 150ms; }
        .filter-pill-suggestion:nth-child(5) { animation-delay: 200ms; }
        
        /* Property card anchor styling */
        .card-hover a {
            text-decoration: none;
            color: inherit;
        }
        
        .card-hover a:hover {
            text-decoration: none;
            color: inherit;
        }
        
        .card-hover a:visited {
            color: inherit;
        }
        
        /* Quick Filter Buttons Styling */
        .filter-quick-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .filter-quick-btn.active {
            background-color: #242426;
            color: white;
            border-color: #242426;
        }
        
        .filter-quick-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .filter-quick-btn.disabled:hover {
            background-color: white;
            border-color: #EDEDF2;
        }

        /* Mobile responsive filter pills */
        @media (max-width: 768px) {
            .filter-quick-btn {
                font-size: 0.625rem;
                padding: 0.375rem 0.75rem;
            }
            
            #quick-filters {
                overflow-x: auto;
                padding-bottom: 8px;
                scrollbar-width: none;
            }
            
            #quick-filters::-webkit-scrollbar {
                display: none;
            }
            
            #active-filters {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 8px;
                scrollbar-width: none;
            }
            
            #active-filters::-webkit-scrollbar {
                display: none;
            }
            
            #filter-suggestions {
                flex-wrap: nowrap;
                overflow-x: auto;
                padding-bottom: 8px;
            }
            
            .filter-pill-active,
            .filter-pill-suggestion {
                flex-shrink: 0;
            }
        }
    </style>
    
    <script>
        // FilterManager class for proper filter state management
        class FilterManager {
            constructor() {
                this.filters = new Map();
                this.searchInput = document.querySelector('input[name="q"]');
                this.init();
            }
            
            init() {
                // Parse existing query on page load
                if (this.searchInput && this.searchInput.value) {
                    this.parseSearchQuery(this.searchInput.value);
                }
                
                // Note: We don't need to listen for search input changes anymore
                // since we're managing filters through the FilterManager directly
                // The old input listener was causing filters to be cleared
            }
            
            parseSearchQuery(query, forceReparse = false) {
                // Only parse if we don't already have filters (initialization only) or forced
                if (this.filters.size > 0 && !forceReparse) {
                    console.log('FilterManager: Skipping parseSearchQuery - filters already exist');
                    return;
                }
                
                if (!query) {
                    if (forceReparse) {
                        console.log('FilterManager: Clearing filters due to empty query');
                        this.filters.clear();
                    }
                    return;
                }
                
                console.log('FilterManager: Parsing query:', query, forceReparse ? '(forced)' : '(initial)');
                
                // Clear filters if force parsing
                if (forceReparse) {
                    this.filters.clear();
                }
                
                const queryLower = query.toLowerCase();
                
                // Parse transaction type
                if (queryLower.includes('venda') || queryLower.includes('comprar')) {
                    this.filters.set('transaction_type', {value: 'venda', label: 'Venda'});
                } else if (queryLower.includes('aluguel') || queryLower.includes('alugar')) {
                    this.filters.set('transaction_type', {value: 'aluguel', label: 'Aluguel'});
                }
                
                // Parse property type
                if (queryLower.includes('apartamento') || queryLower.includes('apto')) {
                    this.filters.set('property_type', {value: 'apartamentos', label: 'Apartamentos'});
                } else if (queryLower.includes('casa')) {
                    this.filters.set('property_type', {value: 'casas', label: 'Casas'});
                } else if (queryLower.includes('terreno')) {
                    this.filters.set('property_type', {value: 'terrenos', label: 'Terrenos'});
                }
                
                // Parse bedrooms
                const bedroomMatch = queryLower.match(/(\d+)\s*(?:quartos?|dormitórios?)/);
                if (bedroomMatch) {
                    const num = bedroomMatch[1];
                    this.filters.set('bedrooms', {value: `${num} quartos`, label: `${num} Quartos`});
                }
                
                // Parse price ranges
                if (queryLower.includes('até') && queryLower.includes('k')) {
                    const priceMatch = queryLower.match(/até (\d+)k/);
                    if (priceMatch) {
                        this.filters.set('price', {value: `até ${priceMatch[1]}k`, label: `Até R$ ${priceMatch[1]}k`});
                    }
                } else if (queryLower.includes('acima de') && queryLower.includes('k')) {
                    const priceMatch = queryLower.match(/acima de (\d+)k/);
                    if (priceMatch) {
                        this.filters.set('price', {value: `acima de ${priceMatch[1]}k`, label: `Acima de R$ ${priceMatch[1]}k`});
                    }
                }
                
                // Parse location
                const locationMatch = queryLower.match(/(?:no|na|em)\s+([a-záêâôõç\s]+?)(?:\s+(?:até|acima|para|com|de\s+[a-z]+|\d)|$)/);
                if (locationMatch) {
                    const location = locationMatch[1].trim();
                    this.filters.set('location', {value: `no ${location}`, label: location.charAt(0).toUpperCase() + location.slice(1)});
                }
            }
            
            addFilter(category, value, label) {
                console.log('FilterManager: Adding filter', category, value, label);
                console.log('FilterManager: Current filters before add:', Array.from(this.filters.entries()));
                
                // Handle mutual exclusivity for transaction types
                if (category === 'transaction_type' && this.filters.has('transaction_type')) {
                    console.log('FilterManager: Replacing existing transaction type');
                    this.filters.delete('transaction_type');
                }
                
                // Add the new filter
                this.filters.set(category, {value, label});
                console.log('FilterManager: Current filters after add:', Array.from(this.filters.entries()));
                
                // Update UI and trigger search
                this.syncSearchBar();
                this.executeSearch();
            }
            
            removeFilter(category) {
                console.log('FilterManager: Removing filter', category);
                console.log('FilterManager: Current filters before removal:', Array.from(this.filters.entries()));
                this.filters.delete(category);
                console.log('FilterManager: Current filters after removal:', Array.from(this.filters.entries()));
                this.syncSearchBar();
                this.executeSearch();
            }
            
            // Force re-sync FilterManager state from search bar (after HTMX updates)
            forceSyncFromSearchBar() {
                if (!this.searchInput) return;
                
                console.log('FilterManager: Force syncing from search bar:', this.searchInput.value);
                this.parseSearchQuery(this.searchInput.value, true);
                console.log('FilterManager: Filters after force sync:', Array.from(this.filters.entries()));
            }
            
            syncSearchBar() {
                if (!this.searchInput) return;
                
                const queryParts = [];
                
                // Add filters in logical order
                if (this.filters.has('transaction_type')) {
                    queryParts.push(this.filters.get('transaction_type').value);
                }
                if (this.filters.has('property_type')) {
                    queryParts.push(this.filters.get('property_type').value);
                }
                if (this.filters.has('bedrooms')) {
                    queryParts.push(this.filters.get('bedrooms').value);
                }
                if (this.filters.has('price')) {
                    queryParts.push(this.filters.get('price').value);
                }
                if (this.filters.has('location')) {
                    queryParts.push(this.filters.get('location').value);
                }
                
                this.searchInput.value = queryParts.join(' ');
            }
            
            executeSearch() {
                if (!this.searchInput) return;
                
                const form = this.searchInput.closest('form');
                if (form) {
                    htmx.trigger(form, 'submit');
                }
            }
            
            getFilterQuery(excludeCategory = null) {
                const queryParts = [];
                
                for (const [category, filter] of this.filters) {
                    if (category !== excludeCategory) {
                        queryParts.push(filter.value);
                    }
                }
                
                return queryParts.join(' ');
            }
        }
        
        // Initialize FilterManager with singleton pattern
        let filterManager;
        
        function initializeFilterManager() {
            if (!filterManager) {
                console.log('FilterManager: Creating new instance');
                filterManager = new FilterManager();
            } else {
                console.log('FilterManager: Using existing instance');
            }
            return filterManager;
        }
        
        // Initialize on DOM ready and HTMX events
        document.addEventListener('DOMContentLoaded', function() {
            initializeFilterManager();
            // Update filter states on initial load
            setTimeout(() => {
                if (filterManager) {
                    updateQuickFilterStates();
                }
            }, 100);
        });
        
        // Re-initialize on HTMX content updates (but preserve existing instance)
        document.addEventListener('htmx:afterSettle', function(event) {
            // Only reinitialize if the search input changed (new search results)
            if (event.target.querySelector('input[name="q"]')) {
                console.log('FilterManager: HTMX update detected');
                initializeFilterManager();
                
                // Force sync FilterManager state with search bar after HTMX update
                // This ensures the state is correct after filter removal/addition
                if (filterManager) {
                    filterManager.forceSyncFromSearchBar();
                }
            }
        });
        
        // Legacy function for backward compatibility (will be updated)
        function updateSearchAndSubmit(query) {
            if (filterManager) {
                // For now, just update the search input directly
                // This will be replaced by proper filter management
                filterManager.searchInput.value = query;
                filterManager.executeSearch();
            } else {
                // Fallback for old behavior
                const searchInput = document.querySelector('input[name="q"]');
                if (searchInput) {
                    searchInput.value = query;
                    const form = searchInput.closest('form');
                    if (form) {
                        htmx.trigger(form, 'submit');
                    }
                }
            }
        }
        
        // Helper function to add a filter through the manager
        function addFilter(category, value, label) {
            if (filterManager) {
                filterManager.addFilter(category, value, label);
            }
        }
        
        // Helper function to remove a filter through the manager  
        function removeFilter(category) {
            if (filterManager) {
                filterManager.removeFilter(category);
            }
        }
        
        // Synchronize sort values between dropdown and hidden field
        function syncSortValues(newSortValue) {
            console.log('SortSync: Updating sort value to:', newSortValue);
            
            // Update hidden field in main search form
            const hiddenSortField = document.getElementById('main-sort-field');
            if (hiddenSortField) {
                hiddenSortField.value = newSortValue;
                console.log('SortSync: Updated hidden field to:', newSortValue);
            }
            
            // Update any sort dropdown that exists
            const sortDropdown = document.querySelector('select[name="sort"]');
            if (sortDropdown) {
                sortDropdown.value = newSortValue;
                console.log('SortSync: Updated dropdown to:', newSortValue);
            }
        }
        
        // New toggle function for static filter buttons
        function toggleFilter(category, value, label) {
            if (filterManager) {
                const hasFilter = filterManager.filters.has(category);
                if (hasFilter && filterManager.filters.get(category).value === value) {
                    filterManager.removeFilter(category);
                } else {
                    filterManager.addFilter(category, value, label);
                }
                updateQuickFilterStates();
            }
        }
        
        // Clear all filters function
        function clearAllFilters() {
            if (filterManager) {
                filterManager.filters.clear();
                filterManager.syncSearchBar();
                filterManager.executeSearch();
                updateQuickFilterStates();
            }
        }
        
        // Update the visual state of quick filter buttons
        function updateQuickFilterStates() {
            const quickFilters = document.querySelectorAll('.filter-quick-btn[data-filter-type]');
            quickFilters.forEach(button => {
                const type = button.dataset.filterType;
                const value = button.dataset.filterValue;
                
                if (filterManager && filterManager.filters.has(type) && 
                    filterManager.filters.get(type).value === value) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
                
                // Handle disabled state for mutually exclusive filters
                if (type === 'transaction_type') {
                    const hasOtherTransaction = filterManager && filterManager.filters.has('transaction_type') &&
                        filterManager.filters.get('transaction_type').value !== value;
                    if (hasOtherTransaction) {
                        button.classList.add('disabled');
                    } else {
                        button.classList.remove('disabled');
                    }
                } else {
                    button.classList.remove('disabled');
                }
            });
        }
        
        // Update filter states after HTMX updates
        document.addEventListener('htmx:afterSettle', function(event) {
            if (event.target.querySelector('input[name="q"]')) {
                setTimeout(() => {
                    if (filterManager) {
                        filterManager.forceSyncFromSearchBar();
                        updateQuickFilterStates();
                    }
                }, 100);
            }
        });
    </script>
</head>
<body class="h-full bg-gray-50 font-sans text-gray-900 antialiased">
    <div class="min-h-full">
        <!-- Refined Header -->
        <header class="bg-white/95 backdrop-blur-md border-b border-gray-200/50 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-3">
                        <a href="/" class="text-xl font-semibold tracking-tight">Reativa</a>
                        <span class="text-xs text-gray-400 font-normal">PROPRIEDADES</span>
                    </div>
                    <nav class="hidden md:flex items-center space-x-8">
                        <a href="/" class="text-sm text-gray-600 hover:text-gray-900 transition-colors">Buscar</a>
                        <a href="#" class="text-sm text-gray-600 hover:text-gray-900 transition-colors">Favoritos</a>
                        <a href="#" class="text-sm text-gray-600 hover:text-gray-900 transition-colors">Contato</a>
                    </nav>
                </div>
            </div>
        </header>
        
        <main class="animate-fade-in">
            {% block content %}{% endblock %}
        </main>
        
        <!-- Minimal Footer -->
        <footer class="bg-white border-t border-gray-100 mt-32">
            <div class="max-w-7xl mx-auto px-6 lg:px-8 py-12">
                <div class="text-center">
                    <p class="text-xs text-gray-400 tracking-wide uppercase mb-2">Portal Reativa</p>
                    <p class="text-sm text-gray-500">Encontre seu espaço ideal</p>
                </div>
            </div>
        </footer>
    </div>
</body>
</html>